!function(t){var e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(s,h,function(e){return t[e]}.bind(null,h));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);let s=[],h=[],r=[],n={};function o(t){const e=t.keyCode;s[e]||(s[e]=!0,h[e]=Date.now(),n={e:t,key:e})}function l(t){const e=t.keyCode;s[e]&&(s[e]=!1,r[e]=Date.now())}const a=[[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]]],d=[[[0,0],[1,0],[1,-1],[0,2],[1,2]],[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],[[0,0],[1,0],[1,1],[0,-2],[1,-2]]];var c=[{shape:[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1}],origin:{x:1.5,y:1.5},className:"grid-cell cyan",wallKickCW:[[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]],wallKickCCW:[[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]]},{shape:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],origin:{x:1,y:1},className:"grid-cell blue",wallKickCW:a,wallKickCCW:d},{shape:[{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],origin:{x:1,y:1},className:"grid-cell orange",wallKickCW:a,wallKickCCW:d},{shape:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],origin:{x:.5,y:.5},className:"grid-cell yellow",wallKickCW:a,wallKickCCW:d},{shape:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1}],origin:{x:1,y:1},className:"grid-cell green",wallKickCW:a,wallKickCCW:d},{shape:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],origin:{x:1,y:1},className:"grid-cell pink",wallKickCW:a,wallKickCCW:d},{shape:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1}],origin:{x:1,y:1},className:"grid-cell red",wallKickCW:a,wallKickCCW:d}];class w{constructor(t,e,i){this.manager=t,this.field=e,this.type=i,this.positions=c[i].shape,this.origin=c[i].origin,this.className=c[i].className,this.rotateCW={rotOffset:1,wallKick:c[i].wallKickCW,rotateFn:t=>t.map(t=>({x:t.x-this.origin.x,y:t.y-this.origin.y})).map(t=>({x:-t.y,y:t.x})).map(t=>({x:t.x+this.origin.x,y:t.y+this.origin.y}))},this.rotateCCW={rotOffset:3,wallKick:c[i].wallKickCCW,rotateFn:t=>t.map(t=>({x:t.x-this.origin.x,y:t.y-this.origin.y})).map(t=>({x:t.y,y:-t.x})).map(t=>({x:t.x+this.origin.x,y:t.y+this.origin.y}))},this.rotation=0,this.lastFall=0,this.slideCap=90,this.slideFrames=0,this.hasMoved=!0,this.lastLeft=h[65]||Date.now(),this.lastRight=h[68]||Date.now(),this.lastUp=h[87]||Date.now(),this.lastDown=h[83]||Date.now(),this.lastCW=h[74]||Date.now(),this.lastCCW=h[75]||Date.now(),this.center()}center(){this.shift(Math.floor(this.field.width/2-this.origin.x-.5),0)}rotate({rotOffset:t,rotateFn:e,wallKick:i}){const s=(this.rotation+t)%4,h=i[s],r=e(this.positions),n=h.find(([t,e])=>((t,e,i)=>t.map(t=>({x:t.x+e,y:t.y+i})))(r,t,e).map(t=>this.field.isOpen(t.x,t.y)).every(t=>t));return!!n&&(this.positions=r,this.shift(n[0],n[1]),this.rotation=s,!0)}canMoveLeft(t=1){return this.positions.map(e=>this.field.isOpen(e.x-t,e.y)).every(t=>t)}shift(t,e){this.positions=this.positions.map(i=>({x:i.x+t,y:i.y+e})),this.origin={x:this.origin.x+t,y:this.origin.y+e}}moveLeft(){this.shift(-1,0),this.hasMoved=!0}canMoveRight(t=1){return this.positions.map(e=>this.field.isOpen(e.x+t,e.y)).every(t=>t)}moveRight(){this.shift(1,0),this.hasMoved=!0}canFall(){return this.positions.map(t=>this.field.isOpen(t.x,t.y+1)).every(t=>t)}canSlide(){return this.hasMoved&&this.slideFrames<this.slideCap}fallSpeed(t){const e=[56,47,39,32,26,21,17,14,12];return t<e.length?e[t]:20-t}fall(){this.shift(0,1)}update(){if(this.canFall()?this.slideFrames=0:this.slideFrames++,s[32]&&this.manager.tetrominoHold(),s[75]&&h[75]>this.lastCW&&(this.lastCW=h[75],this.rotate(this.rotateCCW)),s[74]&&h[74]>this.lastCCW&&(this.lastCCW=h[74],this.rotate(this.rotateCW)),s[65]&&h[65]>this.lastLeft&&this.canMoveLeft()&&(this.lastLeft=h[65],this.moveLeft()),s[68]&&h[68]>this.lastRight&&this.canMoveRight()&&(this.lastRight=h[68],this.moveRight()),s[87]&&h[87]>this.lastUp){for(this.lastUp=h[87];this.canFall();)this.fall();this.manager.tetrominoLands(this)}s[83]&&(this.lastFall+=20),this.lastFall++,this.lastFall>this.fallSpeed(this.manager.level)&&(this.lastFall=0,this.canFall()?this.fall():this.canSlide()?this.hasMoved=!1:this.manager.tetrominoLands(this))}draw(t,e){this.field.drawTetromino(this,t,e)}}var y=["grid-cell","grid-cell cyan","grid-cell blue","grid-cell orange","grid-cell yellow","grid-cell green","grid-cell pink","grid-cell red"];class f{constructor(t,e,i,s,h,r){this.manager=t,this.drawX=h,this.drawY=r,this.width=e,this.height=i,this.hidden=s,this.grid=[];for(let t=0;t<i;t++)this.grid.push(new Array(e).fill(0))}isOpen(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height&&!this.grid[e][t]}addTetromino(t){t.positions.forEach(e=>{e.y>=0&&e.y<this.grid.length&&e.x>=0&&e.x<this.grid[e.y].length&&(this.grid[e.y][e.x]=t.type+1)})}score(){let t=0;for(let e=0;e<this.height;e++)this.grid[e].every(t=>0!=t)&&(this.grid.splice(e,1),this.grid.unshift(new Array(this.width).fill(0)),t++);return t}drawTetromino(t,e,i){const s=Math.floor(i/2);t.positions.forEach(h=>{if(h.y<this.hidden)return;const r=(h.y+t.field.drawY-this.hidden)*i+(t.field.drawX+s+h.x);0<=r&&r<e.length&&(e[r].className=t.className)})}draw(t,e){const i=this.manager.tetromino,s=Math.floor(e/2);for(let h=this.hidden;h<this.height;h++)for(let r=0;r<this.width;r++)i&&i.positions.includes({x:r,y:h})||(t[(h+this.drawY-this.hidden)*e+(this.drawX+s)+r].className=y[this.grid[h][r]])}}class p{constructor(t,e,i){this.isEmpty=!1,this.redraw=!0,this.drawX=e,this.drawY=i,this.width=5,this.height=5,this.classNameBg="grid-cell",this.type=t,this.positions=c[t].shape,this.className=c[t].className,this.center(c[t].origin)}center(t){this.shift(Math.floor(this.width/2-t.x),Math.floor(this.height/2-t.y))}shift(t,e){this.positions=this.positions.map(i=>({x:i.x+t,y:i.y+e}))}draw(t,e){if(!this.redraw)return;this.redraw=!1;const i=Math.floor(e/2);for(let s=0;s<this.height;s++)for(let h=0;h<this.width;h++){const r=(s+this.drawY)*e+(this.drawX+i)+h;t[r].className=this.classNameBg}this.positions.forEach(s=>{t[(s.y+this.drawY)*e+(this.drawX+i)+s.x].className=this.className})}}class g{constructor(t,e){this.isEmpty=!0,this.redraw=!0,this.drawX=t,this.drawY=e,this.width=5,this.height=5,this.classNameBg="grid-cell"}draw(t,e){if(!this.redraw)return;this.redraw=!1;const i=Math.floor(e/2);for(let s=0;s<this.height;s++)for(let h=0;h<this.width;h++)t[(s+this.drawY)*e+(this.drawX+i)+h].className=this.classNameBg}}class m{constructor(t,e,i,s=t.length){this.redraw=!0,this.drawX=e,this.drawY=i,this.width=s,this.height=1,s>t.length?this.text=t.concat(Array(s-t.length).fill(" ").join("")):this.text=t.split("").slice(0,s).join("")}draw(t,e){if(!this.redraw)return;this.redraw=!1;const i=Math.floor(e/2),s=this.drawY*e+this.drawX+i;this.text.split("").forEach((e,i)=>{t[s+i].className="grid-cell",t[s+i].innerText=e})}}class u{constructor(t){this.randFromBag=(()=>{const t=[0,1,2,3,4,5,6];let e=[];return()=>(0===e.length&&(e=function(t){for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t}([...t])),e.pop())})(),this.newGame=t,this.isGameOver=!1,this.justHeld=!1,this.level=1,this.best=localStorage.getItem("best")||0,this.lines=0,this.score=0,this.field=new f(this,10,26,2,-5,2),this.tetromino=new w(this,this.field,this.randFromBag()),this.next=new p(this.randFromBag(),7,10),this.hold=new g(-12,10),this.levelLabel=new m(this.level.toString(),-12,3,5),this.linesLabel=new m(this.lines.toString(),-12,6,5),this.bestLabel=new m(this.best.toString(),7,3,5),this.scoreLabel=new m(this.score.toString(),7,6,5),this.scene=[this.field,this.tetromino,this.next,this.hold,this.levelLabel,this.linesLabel,this.bestLabel,this.scoreLabel],this.scene.push(new m("LEVEL",-12,2,5)),this.scene.push(new m("LINES",-12,5,5)),this.scene.push(new m("BEST",7,2,5)),this.scene.push(new m("SCORE",7,5,5)),this.scene.push(new m("NEXT",7,8,5)),this.scene.push(new m("HOLD",-12,8,5))}update(){this.isGameOver?this.checkNewGame():this.scene.filter(t=>"function"==typeof t.update).forEach(t=>t.update())}tetrominoLands(t){if(!t.positions.every(t=>t.y>this.field.hidden))return void this.gameOver();this.justHeld=!1,this.field.addTetromino(t);const e=this.field.score();if(e){this.lines+=e;const t=[0,100,200,400,600];this.score+=t[e],this.level=Math.floor(this.lines/10)+1,this.updateLabels()}this.destroy(t),this.tetromino=new w(this,this.field,this.next.type),this.scene.push(this.tetromino),this.destroy(this.next),this.next=new p(this.randFromBag(),this.next.drawX,this.next.drawY),this.scene.push(this.next)}updateLabels(){this.destroy(this.linesLabel),this.linesLabel=new m(this.lines.toString(),this.linesLabel.drawX,this.linesLabel.drawY,5),this.scene.push(this.linesLabel),this.destroy(this.levelLabel),this.levelLabel=new m(this.level.toString(),this.levelLabel.drawX,this.levelLabel.drawY,5),this.scene.push(this.levelLabel),this.destroy(this.scoreLabel),this.scoreLabel=new m(this.score.toString(),this.scoreLabel.drawX,this.scoreLabel.drawY,5),this.scene.push(this.scoreLabel),this.score>this.best&&(this.destroy(this.bestLabel),this.bestLabel=new m(this.score.toString(),this.bestLabel.drawX,this.bestLabel.drawY,5),this.scene.push(this.bestLabel))}destroy(t){const e=this.scene.indexOf(t);-1!==e?this.scene.splice(e,1):console.error("Entity not found for deletion")}gameOver(){this.isGameOver=!0,this.score>this.best&&localStorage.setItem("best",this.score),this.scene.push(new m("GAME OVER",-5,5)),this.scene.push(new m("ENTER TO",-5,7)),this.scene.push(new m("RESTART",-5,8))}checkNewGame(){s[13]&&this.newGame()}tetrominoHold(){if(!this.justHeld){if(this.hold.isEmpty)this.destroy(this.hold),this.hold=new p(this.tetromino.type,this.hold.drawX,this.hold.drawY),this.scene.push(this.hold),this.destroy(this.tetromino),this.tetromino=new w(this,this.field,this.next.type),this.scene.push(this.tetromino),this.destroy(this.next),this.next=new p(this.randFromBag(),this.next.drawX,this.next.drawY),this.scene.push(this.next);else{const t=this.hold.type;this.destroy(this.hold),this.hold=new p(this.tetromino.type,this.hold.drawX,this.hold.drawY),this.scene.push(this.hold),this.destroy(this.tetromino),this.tetromino=new w(this,this.field,t),this.scene.push(this.tetromino)}this.justHeld=!0}}forceRedraw(){this.scene.filter(t=>"boolean"==typeof t.redraw).forEach(t=>t.redraw=!0)}draw(t,e){this.scene.filter(t=>"function"==typeof t.draw).forEach(i=>i.draw(t,e))}}let x=14,b=28;const v=document.querySelector("#tetris-container");let L=new u(function t(){L=new u(t);N(!0)}),C=[];function k(){L.draw(C,x)}function W(){L.update(),k(),window.requestAnimationFrame(W)}function N(t=!1){let e=window.innerWidth/window.innerHeight;v.style.width=window.innerWidth,v.style.height=window.innerHeight;const i=Math.ceil(b*e);if(t||i!==x){x=i;const t=document.querySelector("#tetris-container");for(;t.firstChild;)t.removeChild(t.firstChild);for(let t=0;t<x*b;t++){const t=document.createElement("div");t.className="grid-cell grey",v.appendChild(t)}C=Array.from(document.querySelectorAll(".grid-cell")),t.style.setProperty("grid-template-columns",`repeat(${x}, 1fr)`),t.style.setProperty("grid-template-rows",`repeat(${b}, 1fr)`);const e=`${Math.floor(.6*(C[0].offsetWidth-2))}px`;console.log(e,C[0].offsetWidth),t.style.setProperty("font-size",e)}L.forceRedraw(),k()}function E(t,e,i,s,h){const r=document.querySelector("#error-handler"),n=document.querySelector("#error-message");if(document.removeEventListener("keydown",o),document.removeEventListener("keyup",l),r.style.display="block",h&&h.stack){const t=h.stack.split("\n").map(t=>"\t"+t).join("\n"),e=`${h.name}: ${h.message}\n${t}`;console.error(e),n.innerText=e}else{const h=`${t}\n\t${e}:${i}:${s}\n\t(fallback error handler)`;console.error(h),n.innerText=h}}window.onerror=E,document.addEventListener("keydown",o),document.addEventListener("keyup",l),N(),window.addEventListener("resize",N),W()}]);
//# sourceMappingURL=bundle.js.map